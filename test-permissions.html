<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Permissions</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .status-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #dee2e6;
        }
        .status-item.granted {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .status-item.denied {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .status-item.unsupported {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .status-item.error {
            border-left-color: #6c757d;
            background: #e9ecef;
        }
        .status-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .status-value {
            font-size: 14px;
            color: #666;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .log {
            margin-top: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Тест разрешений REonika</h1>
        <p>Эта страница проверяет работу системы разрешений без модальных окон.</p>
        
        <div class="status-grid" id="status-grid">
            <!-- Статусы разрешений будут добавлены здесь -->
        </div>
        
        <div class="controls">
            <button class="btn-primary" onclick="requestAllPermissions()">Запросить все разрешения</button>
            <button class="btn-secondary" onclick="refreshStatus()">Обновить статус</button>
            <button class="btn-success" onclick="clearStorage()">Очистить память</button>
        </div>
        
        <div class="log" id="log">
            <!-- Лог действий будет добавлен здесь -->
        </div>
    </div>

    <script>
        // Имитация PermissionManager для тестирования
        class TestPermissionManager {
            constructor() {
                this.permissions = {
                    notifications: 'default',
                    microphone: 'default',
                    camera: 'default',
                    clipboard: 'default',
                    geolocation: 'default',
                    persistentStorage: 'default'
                };
                this.logElement = document.getElementById('log');
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.logElement.innerHTML += `[${timestamp}] ${message}\n`;
                this.logElement.scrollTop = this.logElement.scrollHeight;
            }

            async requestNotificationPermission() {
                if (!('Notification' in window)) {
                    this.log('Notifications not supported');
                    return { permission: 'unsupported', name: 'notifications' };
                }

                try {
                    const permission = await Notification.requestPermission();
                    this.permissions.notifications = permission;
                    this.log(`Notification permission: ${permission}`);
                    return { permission, name: 'notifications' };
                } catch (error) {
                    this.log(`Error requesting notification permission: ${error.message}`);
                    return { permission: 'error', name: 'notifications', error };
                }
            }

            async requestMicrophonePermission() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.log('Microphone not supported');
                    return { permission: 'unsupported', name: 'microphone' };
                }

                try {
                    let permissionState = 'prompt';
                    
                    if (navigator.permissions) {
                        try {
                            const permission = await navigator.permissions.query({ name: 'microphone' });
                            permissionState = permission.state;
                            this.permissions.microphone = permission.state;
                        } catch (permError) {
                            this.log(`Could not query microphone permission: ${permError.message}`);
                        }
                    }
                    
                    if (permissionState === 'prompt' || permissionState === 'default') {
                        const constraints = {
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                autoGainControl: true
                            },
                            video: false
                        };
                        
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        stream.getTracks().forEach(track => track.stop());
                        
                        if (navigator.permissions) {
                            try {
                                const updatedPermission = await navigator.permissions.query({ name: 'microphone' });
                                this.permissions.microphone = updatedPermission.state;
                                this.log(`Microphone permission granted: ${updatedPermission.state}`);
                                return { permission: updatedPermission.state, name: 'microphone' };
                            } catch (updateError) {
                                this.log(`Could not update microphone permission status: ${updateError.message}`);
                            }
                        }
                        
                        this.log('Microphone permission granted');
                        return { permission: 'granted', name: 'microphone' };
                    }
                    
                    return { permission: permissionState, name: 'microphone' };
                } catch (error) {
                    this.log(`Error requesting microphone permission: ${error.message}`);
                    
                    if (error.name === 'NotAllowedError') {
                        this.log('Microphone access denied by user');
                    } else if (error.name === 'NotFoundError') {
                        this.log('No microphone device found');
                    } else if (error.name === 'NotReadableError') {
                        this.log('Microphone is already in use by another application');
                    }
                    
                    return { permission: 'denied', name: 'microphone', error };
                }
            }

            async requestCameraPermission() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.log('Camera not supported');
                    return { permission: 'unsupported', name: 'camera' };
                }

                try {
                    const permission = await navigator.permissions.query({ name: 'camera' });
                    this.permissions.camera = permission.state;
                    
                    if (permission.state === 'prompt') {
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            audio: false,
                            video: true 
                        });
                        stream.getTracks().forEach(track => track.stop());
                        this.log('Camera permission granted');
                    }
                    
                    return { permission: permission.state, name: 'camera' };
                } catch (error) {
                    this.log(`Error requesting camera permission: ${error.message}`);
                    return { permission: 'denied', name: 'camera', error };
                }
            }

            async requestClipboardPermission() {
                if (!navigator.permissions || !navigator.clipboard) {
                    this.log('Clipboard API not supported');
                    return { permission: 'unsupported', name: 'clipboard' };
                }

                try {
                    if (navigator.clipboard && navigator.clipboard.readText) {
                        const permission = await navigator.permissions.query({ name: 'clipboard-read' });
                        this.permissions.clipboard = permission.state;
                        return { permission: permission.state, name: 'clipboard' };
                    }
                    return { permission: 'unsupported', name: 'clipboard' };
                } catch (error) {
                    this.log(`Error requesting clipboard permission: ${error.message}`);
                    return { permission: 'error', name: 'clipboard', error };
                }
            }

            async requestGeolocationPermission() {
                if (!navigator.geolocation) {
                    this.log('Geolocation not supported');
                    return { permission: 'unsupported', name: 'geolocation' };
                }

                try {
                    const permission = await navigator.permissions.query({ name: 'geolocation' });
                    this.permissions.geolocation = permission.state;
                    
                    if (permission.state === 'prompt') {
                        await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(
                                resolve, 
                                reject,
                                { timeout: 5000, enableHighAccuracy: false }
                            );
                        });
                        this.log('Geolocation permission granted');
                    }
                    
                    return { permission: permission.state, name: 'geolocation' };
                } catch (error) {
                    this.log(`Error requesting geolocation permission: ${error.message}`);
                    return { permission: 'denied', name: 'geolocation', error };
                }
            }

            async requestPersistentStoragePermission() {
                if (!navigator.storage || !navigator.storage.persist) {
                    this.log('Persistent storage not supported');
                    return { permission: 'unsupported', name: 'persistentStorage' };
                }

                try {
                    const isPersistent = await navigator.storage.persist();
                    this.permissions.persistentStorage = isPersistent ? 'granted' : 'denied';
                    this.log(`Persistent storage permission: ${isPersistent}`);
                    return { permission: isPersistent ? 'granted' : 'denied', name: 'persistentStorage' };
                } catch (error) {
                    this.log(`Error requesting persistent storage permission: ${error.message}`);
                    return { permission: 'error', name: 'persistentStorage', error };
                }
            }

            async requestAllPermissions() {
                this.log('Requesting all permissions...');
                
                const permissionPromises = [
                    this.requestNotificationPermission(),
                    this.requestMicrophonePermission(),
                    this.requestCameraPermission(),
                    this.requestClipboardPermission(),
                    this.requestGeolocationPermission(),
                    this.requestPersistentStoragePermission()
                ];

                try {
                    const results = await Promise.allSettled(permissionPromises);
                    this.log('Permission request results:', JSON.stringify(results, null, 2));
                    this.updateStatusGrid();
                } catch (error) {
                    this.log(`Error requesting permissions: ${error.message}`);
                }
            }

            async refreshStatus() {
                this.log('Refreshing permissions status...');
                
                const permissionPromises = [
                    this.checkPermissionStatus('notifications'),
                    this.checkPermissionStatus('microphone'),
                    this.checkPermissionStatus('camera'),
                    this.checkPermissionStatus('clipboard'),
                    this.checkPermissionStatus('geolocation'),
                    this.checkPermissionStatus('persistentStorage')
                ];

                try {
                    const results = await Promise.allSettled(permissionPromises);
                    
                    results.forEach((result, index) => {
                        const permissionNames = ['notifications', 'microphone', 'camera', 'clipboard', 'geolocation', 'persistentStorage'];
                        const name = permissionNames[index];
                        if (result.status === 'fulfilled') {
                            this.permissions[name] = result.value;
                        }
                    });
                    
                    this.log('Permissions refreshed:', JSON.stringify(this.permissions, null, 2));
                    this.updateStatusGrid();
                    
                } catch (error) {
                    this.log(`Error refreshing permissions: ${error.message}`);
                }
            }

            async checkPermissionStatus(permissionName) {
                if (!navigator.permissions) {
                    return 'unsupported';
                }
                
                try {
                    const permission = await navigator.permissions.query({ name: permissionName });
                    return permission.state;
                } catch (error) {
                    this.log(`Error checking permission status: ${error.message}`);
                    return 'error';
                }
            }

            updateStatusGrid() {
                const grid = document.getElementById('status-grid');
                grid.innerHTML = '';
                
                const permissionNames = {
                    notifications: 'Уведомления',
                    microphone: 'Микрофон',
                    camera: 'Камера',
                    clipboard: 'Буфер обмена',
                    geolocation: 'Геолокация',
                    persistentStorage: 'Постоянное хранилище'
                };

                for (const [key, value] of Object.entries(this.permissions)) {
                    const item = document.createElement('div');
                    item.className = `status-item ${value}`;
                    item.innerHTML = `
                        <div class="status-name">${permissionNames[key] || key}</div>
                        <div class="status-value">${value}</div>
                    `;
                    grid.appendChild(item);
                }
            }
        }

        // Инициализация
        const permissionManager = new TestPermissionManager();
        permissionManager.updateStatusGrid();
        permissionManager.log('Test Permission Manager initialized');

        // Глобальные функции для кнопок
        window.requestAllPermissions = () => permissionManager.requestAllPermissions();
        window.refreshStatus = () => permissionManager.refreshStatus();
        window.clearStorage = () => {
            localStorage.removeItem('permissions_requested');
            permissionManager.log('Storage cleared - permissions will be requested again on next visit');
        };
    </script>
</body>
</html>
